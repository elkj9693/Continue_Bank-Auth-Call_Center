# Project Continuity Memo (2026-01-28)

이 파일은 현재까지 진행된 모든 작업 내역과 시스템 설정 상태를 요약하여 다시 방문했을 때 즉각적인 학습이 가능하도록 한 것입니다.

## 1. 최근 작업 요약 (2026-01-28 업데이트)

### 1.1 S2S 토큰 검증 고도화
- **토큰 일회성 사용 (Consume API):** `POST /api/v1/auth/consume/{tokenId}`
    - 수탁사에서 토큰 검증 후 `USED` 상태로 변경 (재사용 불가)
    - 회원가입, 계좌개설 시 필수 호출
- **AuthStatus 확장:** `PENDING → COMPLETED → USED → EXPIRED`
- **S2SAuthService 개선:** `consumeTokenWithTrustee()` 메서드 추가

### 1.2 OTP/SMS 발송 시스템 구축
- **SmsService 신규 생성:** AWS SNS 연동 준비 완료
    - `sms.enabled=false`: 콘솔 로그만 출력 (개발 모드)
    - `sms.enabled=true`: AWS SNS를 통한 실제 SMS 발송 (운영 모드)
- **테스트 모드 분기:** `auth.test-mode=true`면 응답에 OTP 포함
- **SecureRandom 사용:** 암호학적으로 안전한 난수 생성

### 1.3 계좌 시스템 무결성 강화
- **계좌번호 형식 변경:** `110-XXX-XXXXXX` (은행코드-지점코드-일련번호)
- **중복 검증:** 계좌번호 생성 시 DB 조회로 유일성 확인
- **본인인증 재확인:** `user.isVerified()` 체크 필수

### 1.4 환경변수 포트 통일
- **수탁사 백엔드:** `8086` (기존 8088/8086 혼재 → 8086으로 통일)
- **위탁사 백엔드:** `8085`
- **프론트엔드:** 위탁사 `5175`, 수탁사 `5176`

### 1.5 기존 구현 내역
- **Server-to-Server (S2S) 인증:** 수탁사-위탁사 서버 간 직접 토큰 검증
- **비즈니스 로직:** 가입 축하금(10,000원) 첫 번째 계좌에만 지급
- **보안 강화:** 통신사 명의 대조, OTP 3분 제한, PIN 5회 오류 잠금
- **Login Guard:** 미인증 사용자 대시보드 접근 차단

## 2. 시스템 환경 및 이슈 해결 내역
- **데이터베이스:** H2 예약어 충돌 이슈 해결을 위해 `User` 테이블 이름을 **`site_users`**로 변경함.
- **포트 구성:**
    - 위탁사 (Continue - Entrusting Client): 8085 (Backend), [http://localhost:5175](http://localhost:5175) (Frontend)
    - 수탁사 (Trustee Provider): 8086 (Backend), [http://localhost:5176](http://localhost:5176) (Frontend)
- **명령어 환경:** 
    - `netstat` 등 시스템 명령어 사용을 위해 `C:\Windows\System32`를 PATH에 임시 등록함.
    - `taskkill` 명령어를 통해 좀비 프로세스(Java)를 정리하여 포트 충돌 방지 로직 구축함.

## 3. 본인인증 테스트용 데이터 리스트 (MockCarrierDatabase)
본인인증 테스트 시 아래 리스트와 **[성명 / 전화번호 / 통신사]**가 모두 일치해야 인증이 성공합니다.

| 성명 | 전화번호 | 통신사 |
| :--- | :--- | :--- |
| **김중수** | 010-9511-9924 | SKT |
| **방수진** | 010-8717-6882 | KT |
| **김은수** | 010-5133-7437 | LG U+ |
| **이광진** | 010-3065-9593 | 알뜰폰 (ALDDLE) |
| **임혜진** | 010-3731-5819 | SKT |
| **전용준** | 010-5047-0664 | KT |
| **김유진** | 010-9287-7379 | LG U+ |
| **장민아** | 010-4932-8977 | SKT |
| **이승원** | 010-9212-8221 | KT |
| **홍길동** | 010-0000-0000 | SKT |

## 4. 남아있는 과제 / 다음 단계

### 4.1 즉시 적용 가능
- [x] S2S 토큰 일회성 사용 (Consume API)
- [x] OTP SMS 발송 시스템 구축 (AWS SNS 연동 준비)
- [x] 계좌번호 중복 검증
- [x] 환경변수 포트 통일 (8086)

### 4.2 운영 전환 시 필요
- [ ] AWS SNS SMS 발송 활성화 (`sms.enabled=true`)
- [ ] 테스트 모드 비활성화 (`auth.test-mode=false`)
- [ ] 운영 DB 전환 (MySQL/PostgreSQL)
- [ ] HTTPS/TLS 인증서 적용

---

## 5. 2026 컴플라이언스 체크리스트

### 5.1 신용정보법 (신용정보의 이용 및 보호에 관한 법률)
| 항목 | 요구사항 | 현재 상태 | TODO |
|------|----------|----------|------|
| 본인확인 기록 보관 | 2년 이상 | 🟡 로그만 | 별도 감사 테이블 필요 |
| 개인신용정보 암호화 | AES-256 등 | 🟡 BCrypt (비밀번호만) | PII 필드 암호화 필요 |
| 제3자 제공 동의 | 명시적 동의 | 🔴 미구현 | 동의 화면/기록 필요 |

### 5.2 개인정보보호법
| 항목 | 요구사항 | 현재 상태 | TODO |
|------|----------|----------|------|
| 최소 수집 원칙 | 필요 정보만 | ✅ 구현됨 | - |
| 목적 달성 시 파기 | 보유기간 후 삭제 | 🔴 미구현 | 자동 삭제 배치 필요 |
| 접근 권한 관리 | 권한별 접근 제어 | 🟡 기본 구현 | RBAC 고도화 필요 |
| 로그 기록 | 접근/처리 이력 | 🟡 콘솔 로그 | ELK/CloudWatch 연동 |

### 5.3 전자금융거래법
| 항목 | 요구사항 | 현재 상태 | TODO |
|------|----------|----------|------|
| 거래 기록 보관 | 5년 이상 | 🟡 DB 저장 | 장기 보관 정책 필요 |
| 본인인증 수단 | 2채널 인증 | ✅ SMS OTP | - |
| 이상거래 탐지 | FDS 시스템 | 🔴 미구현 | FDS 모듈 개발 필요 |
| 거래 한도 관리 | 일/건 한도 | 🔴 미구현 | 한도 설정 기능 필요 |

### 5.4 금융위원회 가이드라인
| 항목 | 요구사항 | 현재 상태 | TODO |
|------|----------|----------|------|
| OTP 유효시간 | 3분 이내 | ✅ 구현됨 | - |
| 비밀번호 오류 | 5회 잠금 | ✅ 구현됨 | - |
| 계좌 잠금 해제 | 본인확인 후 | 🔴 미구현 | 해제 프로세스 필요 |

---

## 6. 코드 내 컴플라이언스 주석 위치

### 수탁사 (trustee-provider)
- `AuthService.java`: `[COMPLIANCE-AUDIT]` 로그 태그
- `SmsService.java`: `[COMPLIANCE-LOG]` SMS 발송 이력

### 위탁사 (entrusting-client)
- `AccountService.java`: `[COMPLIANCE-TX]` 거래 기록
- `S2SAuthService.java`: S2S 통신 로그

---

상세 구현 내역은 소스코드 주석 및 본 문서에 기록되어 있습니다.
